<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Page Needs
      ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
   <meta charset="utf-8">
   <title>Ultimate Flaggle</title>
   <meta name="description" content="Website for playing the game 'Ultimate Flaggle'.">
   <meta name="author" content="Cheylea Hopkinson">
   <!-- CSS
      ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
   <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/stylesheet.css') }}" media="screen and (min-width: 768px)">
   <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/stylesheet-mobile.css') }}" media="screen and (max-width: 767px)">
   
   <!-- Favicon
      ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
   <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Libraries
      ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Header -->
<div class="header">
   <h2>Ultimate Flaggle</h2>
</div>

<!-- Popup icons for how to play and view current stats -->
<div class="row">
  <div class="column-left" ></div>
  <div class="column-mid">
    <!-- How to button -->
    <header style="background-color:#E9F1F7;">
      <span style="border-radius: 50%; margin: 2px;" onclick="document.getElementById('howToPopup').style.display='block'; document.getElementById('myStats').style.display='none'; document.getElementById('youWin').style.display='none'; document.getElementById('youLose').style.display='none';" class="how-to topright">&#10067;</span>
    </header>
    <!-- Stats button -->
    <header style="background-color:#E9F1F7;">
      <span style="border-radius: 50%; margin: 2px;" onclick="document.getElementById('myStats').style.display='block'; document.getElementById('howToPopup').style.display='none'; document.getElementById('youWin').style.display='none'; document.getElementById('youLose').style.display='none';" class="how-to topright">&#128202;</span>
    </header>
    <br>
    <br>
    <!--Top text-->
    <p class="top-text">You have 6 chances to guess a mystery flag based on the Distance üìê, Direction üß≠ and Colour Difference üè≥Ô∏è‚Äçüåà.</p>
    <p class="top-text">Flags have been changed slightly to align with the set colours below. The 'Colour Difference' image will show bright green where there is a match between colour and location.</p>
    <p class="top-text">For more details on how this works, click the question mark at the top right.</p>
    <p class="top-text">Select a country below to get started. Good luck!</p>
    <!--Show count down for guesses remaining-->
    <p class="top-text">Guesses Remaining: {{ total_guesses }} / 6 </p>
    
    
    
    <!--Generate countries -->
    <div style="width:15%; float: left;" ></div>
    <form action="{{ url_for('guesscountry') }}" method="post">
      <select id="guessedcountry" name="guessedcountry" class="select">
          <option disabled selected value> -- pick a country to guess! -- </option>
          {% for country in countries %}
          <option value="{{ country }}">{{ country }}</option>
          {% endfor %}
      </select>
    
      <!-- Guess button -->
      <input class="guessButton" id="guess-button" type="submit" value="GUESS!">
    </form>
    <div style="width:15%; float: left;"></div>

    <!-- Display possible colours-->
    <br>
    <p><div class="circle-main" style="background: #000000;"></div>
      <div class="circle-main" style="background: #0F41A3;"></div>
      <div class="circle-main" style="background: #00AFCA;"></div>
      <div class="circle-main" style="background: #8CB9DA;"></div>
      <div class="circle-main" style="background: #9216A0;"></div>
      <div class="circle-main" style="background: #CE2424;"></div>
      <div class="circle-main" style="background: #F48E93;"></div>
      <div class="circle-main" style="background: #007934;"></div>
      <div class="circle-main" style="background: #FAF341;"></div>
      <div class="circle-main" style="background: #EACB3F;"></div>
      <div class="circle-main" style="background: #ff8000;"></div>
      <div class="circle-main" style="background: #61362E;"></div>
      <div class="circle-main" style="background: #a0a0a0;"></div>
      <div class="circle-main" style="background: #DECDB6;"></div>
      <div class="circle-main" style="background: #FFFFFF;"></div>
    </p>
    <br>
    <br>
    <table class="myTable" style="border-radius:  15px 15px 15px 15px;">

      <tr>
          <th>Flag & Country</th>
          <th>Distance & Direction</th>
          <th>Colour Difference</th>
      </tr>
      {% for flag, country, distance, direction, image in guesses %}
      <tr>
         <td><img src="{{ flag }}" onmouseover="changeImageOnHover(this)" onmouseout="revertImage(this)" style="cursor:pointer;max-width: 100%; height: auto;"><br>{{ country }}</td>
          <td><img src="{{ direction }}" style="max-width: 35%; height: auto;"><br>{{ distance }}</td>
          <td><img src="{{ image }}" style="max-width: 100%; height: auto;"></td>
      </tr>
      {% endfor %}
    </table>
    <br>
   <!--Hidden pop ups-->
    <!-- Current Stats -->
    <div class="howToPopup" id="myStats" style="display: none;">
      <!-- Close button in the top right -->
      <header style="background-color:#E9F1F7;color:#231651;">
        <span onclick="document.getElementById('myStats').style.display='none'" class="close-button topright">&times;</span>
      </header>
      <!-- Stats -->
      <table class="statsTable">
        <tr>
            <th>Win Streak</th>
            <th>Average Guesses</th>
            <th>Average Minutes</th>
        </tr>
        <tr>
           <td>{{current_streak}}</td>
            <td>{{ average_win_guesses }}</td>
            <td>{{ average_win_time }}</td>
        </tr>
      </table>
      <table class="statsTable">
        <tr>
            <th>Max Streak</th>
            <th>Win Rate</th>
            <th>Total Played</th>
        </tr>
        <tr>
            <td>{{ max_streak }}</td>
            <td>{{ win_rate }}</td>
            <td>{{ total_played }}</td>
        </tr>
      </table>
      <canvas id="userChart"></canvas>
    </div>
    <!-- How to pop up -->
    <div class="howToPopup" id="howToPopup">
      <!-- Close button in the top right -->
      <header style="background-color:#E9F1F7;color:#231651;">
        <span onclick="document.getElementById('howToPopup').style.display='none'" class="close-button topright">&times;</span>
      </header>
      <!-- Show icon on the page -->
      <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="ultimate flaggle logo">
      <!-- How to details -->
      <h1>How does it work?</h1>
      <br>
      <p>
        This version of flaggle works by combining the approachs of <a href="https://flagle.gg/" target="_blank">FLAGLE</a> and <a href="https://www.flaggle.net/" target="_blank">Flaggle</a>.
        <br>
        To play, guess a country to start. Once you start guessing, you are shown hints for how close you are to the correct country to guess. Hints are the distance, direction and flag colour comparison.
        The flag colour comparison works by comparing the pixel colours in the same position and will highlight green when they match.
        See the below example for guessing China, when the answer is the United States.
      </p>
      <div>
        <div class="column-left" ></div>
        <img style="float: left; margin-top: 1%; margin-left: 1%; margin-right: 1%;" src="{{ url_for('static', filename='images/cleaned_flags/cn.png') }}" alt="example flag difference">
        <img style="float: left; margin-top: 1%; margin-left: 1%; margin-right: 1%;" src="{{ url_for('static', filename='images/output_us_cn.png') }}" alt="example flag difference">
        <img style="float: left; margin-top: 1%; margin-left: 1%; margin-right: 1%;" src="{{ url_for('static', filename='images/cleaned_flags/us.png') }}" alt="example flag difference">
        <div class="column-left" ></div>
      </div>
      
      <p>
        <br>
        <br>
        <br>
        <br>
        <br>
        Please note, flags have been processed to be the same dimensions and only contain colour shades from a set of 15 colours. This means flags may not look exactly identical to the original flag, so do bear that in mind when playing.
      </p>
      <br>
      <p> Colours used to process flags:</p>
      <br>
      <p><div class="circle" style="background: #000000;"></div>
        <div class="circle" style="background: #0F41A3;"></div>
        <div class="circle" style="background: #00AFCA;"></div>
        <div class="circle" style="background: #8CB9DA;"></div>
        <div class="circle" style="background: #9216A0;"></div>
        <div class="circle" style="background: #CE2424;"></div>
        <div class="circle" style="background: #F48E93;"></div>
        <div class="circle" style="background: #007934;"></div>
      </p>
      <p>
        <div class="circle" style="background: #FAF341; margin-left:calc(100% / 20);"></div>
        <div class="circle" style="background: #EACB3F;"></div>
        <div class="circle" style="background: #ff8000;"></div>
        <div class="circle" style="background: #61362E;"></div>
        <div class="circle" style="background: #a0a0a0;"></div>
        <div class="circle" style="background: #DECDB6;"></div>
        <div class="circle" style="background: #FFFFFF;"></div>
      </p>
    </div>

    <!-- Winning pop up-->
    <div class="howToPopup" id="youWin" style="display: none;">
      <!-- Close button in the top right -->
      <header style="background-color:#E9F1F7;color:#231651;">
        <span onclick="document.getElementById('youWin').style.display='none'; document.getElementById('howToPopup').style.display='none'; document.getElementById('myStats').style.display='none';" class="close-button topright">&times;</span>
      </header>
      <!-- Winning details and stats -->
      <p>Flag superstar - you won! It was {{ country }}. </p>
      <p>Come back tomorrow to keep up your streak.</p>
      <img src="{{ countryurl }}" style="max-width: 30%; height: auto; margin: 2%;">
      
      <table class="statsTable">
        <tr>
            <th>Win Streak</th>
            <th>Average Guesses</th>
            <th>Average Minutes</th>
        </tr>
        <tr>
           <td>{{current_streak}}</td>
            <td>{{ average_win_guesses }}</td>
            <td>{{ average_win_time }}</td>
        </tr>
      </table>
      <table class="statsTable">
        <tr>
            <th>Max Streak</th>
            <th>Win Rate</th>
            <th>Total Played</th>
        </tr>
        <tr>
            <td>{{ max_streak }}</td>
            <td>{{ win_rate }}</td>
            <td>{{ total_played }}</td>
        </tr>
      </table>
      <canvas id="userChartWin"></canvas>
    </div>
  
    <!-- Losing pop up -->
    <div class="howToPopup" id="youLose" style="display: none;">
      <!-- Close button in the top right -->
      <header style="background-color:#E9F1F7;color:#231651;">
        <span onclick="document.getElementById('youLose').style.display='none'; document.getElementById('howToPopup').style.display='none'; document.getElementById('myStats').style.display='none';" class="close-button topright">&times;</span>
      </header>
      <!-- Losing details and stats -->
      <p>Oh no you're out of guesses! The correct answer was {{ country }}.</p>
      <p>Try again tomorrow.</p>
      <img src="{{ countryurl }}" style="max-width: 30%; height: auto; margin: 2%;">
      <table class="statsTable">
        <tr>
            <th>Win Streak</th>
            <th>Average Guesses</th>
            <th>Average Minutes</th>
        </tr>
        <tr>
           <td>{{current_streak}}</td>
            <td>{{ average_win_guesses }}</td>
            <td>{{ average_win_time }}</td>
        </tr>
      </table>
      <table class="statsTable">
        <tr>
            <th>Max Streak</th>
            <th>Win Rate</th>
            <th>Total Played</th>
        </tr>
        <tr>
            <td>{{ max_streak }}</td>
            <td>{{ win_rate }}</td>
            <td>{{ total_played }}</td>
        </tr>
      </table>
      <canvas id="userChartLose"></canvas>
    </div>
  </div>
  <div class="column-left" ></div>
</div>

<div id="cookie-banner" class="cookie-banner">
  <p>We use cookies to track your win streak and stats. No personal data is stored. <a href="{{ url_for('static',filename='policies/privatepolicy.txt') }}" style="color: #F8312F;">Learn more</a>.</p>
  <p>For the app to correctly track your stats, you <b>must</b> accept cookies.</p>
  <br>
  <a onclick="acceptCookies()" href="{{ url_for('accept') }}" class="cookie-button-accept">Accept</a>
  <a onclick="rejectCookies()" href="{{ url_for('reject') }}" class="cookie-button-reject">Reject</a>
</div>

<!-- Footer -->
<div class="footer">
  <p><a href="{{ url_for('static',filename='policies/thankyou.txt') }}" target="_blank">Thank yous</a>. All rights reserved ¬© üå∏ <a href="https://cheylea.github.io/" target="_blank">Cheylea Hopkinson</a> 2025. Contact on üîó <a href="https://www.linkedin.com/in/cheyleahopkinson/" target="_blank">LinkedIn</a>. ‚òï <a href="https://www.ko-fi.com/cheylea" target="_blank">Buy me a coffee?</a></a></p>
</div>

<script>
  function acceptCookies() {
    localStorage.setItem("cookie-consent", "accepted");
    document.getElementById("cookie-banner").style.display = "none";
}

function rejectCookies() {
    localStorage.setItem("cookie-consent", "rejected");
    document.getElementById("cookie-banner").style.display = "none";
}

function checkCookieConsent() {
    if (!localStorage.getItem("cookie-consent")) {
        document.getElementById("cookie-banner").style.display = "block";
    }
}

checkCookieConsent();

  function closeWinPopup() {
    document.getElementById("youWin").style.display = "none";
  }
  function closeLosePopup() {
    document.getElementById("youLose").style.display = "none";
  }
  window.onload = function() {
    var won = {{ won | tojson }};
    var lost = {{ lost | tojson }};

    if (won === 1) {
        document.getElementById("youWin").style.display = "block";
        document.getElementById("guess-button").style.display = "none";

        setTimeout(() => {
          const ctxWin = document.getElementById('userChartWin').getContext('2d');
          new Chart(ctxWin, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Games Won',
                      data: values,
                      borderWidth: 1
                  }]
              },
              options: {
                  indexAxis: 'y',
                  responsive: true,
                  scales: {
                      y: { beginAtZero: true },
                      x: { beginAtZero: true }
                  }
              }
          });
      }, 100);
    } 

    if (lost === 1) {
        document.getElementById("youLose").style.display = "block";
        document.getElementById("guess-button").style.display = "none";

        setTimeout(() => {
          const ctxWin = document.getElementById('userChartLose').getContext('2d');
          new Chart(ctxWin, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Games Won',
                      data: values,
                      borderWidth: 1
                  }]
              },
              options: {
                  indexAxis: 'y',
                  responsive: true,
                  scales: {
                      y: { beginAtZero: true },
                      x: { beginAtZero: true }
                  }
              }
          });
      }, 100);
    } 
  };

  function changeImageOnHover(element) {
            let currentSrc = element.src;
            element.dataset.originalSrc = currentSrc; // Store original src
            element.src = currentSrc.includes("cleaned_flags") 
                ? currentSrc.replace("cleaned_flags", "flags") 
                : currentSrc.replace("flags", "cleaned_flags");
        }

        function revertImage(element) {
            element.src = element.dataset.originalSrc; // Restore original src
        }
  
  const labels = {{ labels | tojson }};
  const values = {{ values | tojson }};

  const ctx = document.getElementById('userChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Total Games Won',
            data: values,
            backgroundColor: '#FF5733', // Change to desired color

        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: {
                labels: {
                    color: 'black', // Makes "Total Games Won" black
                    font: {
                        weight: 'bold'
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'black', // Black grid lines
                    lineWidth: 1
                },
                ticks: {
                    color: 'black', // Makes Y-axis numbers black
                    font: {
                        weight: 'bold'
                    }
                }
            },
            x: {
                beginAtZero: true,
                grid: {
                    color: 'black',
                    lineWidth: 1
                },
                ticks: {
                    color: 'black', // Makes X-axis numbers black
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    }
});
  
  function toggleButton() {
    let selectedValue = $('#guessedcountry').val();
    var button = document.getElementById('guess-button');

    // Disable if no country is selected, enable otherwise
    button.disabled = (selectedValue === null || selectedValue === "");
}

$(document).ready(function() {
    $('#guessedcountry').select2({
        placeholder: " -- pick a country to guess! -- ",
        allowClear: true
    });

    toggleButton();

    $('#guessedcountry').on('change', toggleButton);

    $('#guessedcountry').on('select2:open', function() {
        setTimeout(() => {
            document.querySelector('.select2-container--open .select2-search__field').focus();
        }, 50); // Small delay to ensure the input is available
    });
});

// If a cookie gets deleted, put it on the path to recovery instead of breaking
function checkUniqueIdCookie(callback) {
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    if (!getCookie("unique_id")) {
        if (typeof callback === "function") {
            callback();
        }
    }
}

checkUniqueIdCookie(() => {
    document.getElementById("cookie-banner").style.display = "block";
});

document.addEventListener("DOMContentLoaded", () => {
    const consentStatus = localStorage.getItem("cookie-consent");  // Get consent status
    fetch("/store_consent_status", {  // Send it to Flask
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ "cookie-consent": consentStatus })
    })
    .then(response => response.json())
    .then(data => console.log("Consent stored in session:", data))
    .catch(error => console.error("Error:", error));
});
  
</script>
</body>
</html>